<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì´ë ¥ì„œ ë¶„ì„ ê²°ê³¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .prose h1 { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; }
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; }
        /* ì±„íŒ…ì°½ ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        #chat-window::-webkit-scrollbar { width: 4px; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-100 p-10 pb-20"> <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden mb-10">
    <div class="bg-blue-600 p-6 flex justify-between items-center">
        <h1 class="text-2xl text-white font-bold">AI ê¸°ìˆ  ë©´ì ‘ê´€ì˜ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
        <a href="/resume/history" class="text-blue-100 hover:text-white text-sm underline">ë¶„ì„ ì´ë ¥ ë³´ê¸°</a>
    </div>

    <div class="p-8">
        <div id="content" class="prose text-gray-800">
            <div class="flex justify-center p-10" id="loader">
                <p class="text-blue-500 animate-pulse">ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>

        <div class="mt-10 border-t pt-6 flex justify-end">
            <a href="/resume/upload" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">ë‹¤ì‹œ ë¶„ì„í•˜ê¸°</a>
            <button onclick="window.print()" class="ml-4 px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">PDF ì €ì¥</button>
        </div>
    </div>
</div>

<div id="chat-container" class="fixed bottom-5 right-5 w-80 md:w-96 shadow-2xl rounded-xl border border-gray-200 bg-white overflow-hidden flex flex-col z-50" style="height: 450px;">
    <div class="bg-blue-600 p-4 text-white font-bold flex justify-between items-center">
        <span>ğŸ¤– AI ì»¨ì„¤í„´íŠ¸ ì§ˆë¬¸í•˜ê¸°</span>
        <button onclick="document.getElementById('chat-container').classList.toggle('hidden')" class="text-white">âœ•</button>
    </div>
    <div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50">
        <div class="bg-blue-100 text-blue-800 p-3 rounded-lg text-sm self-start max-w-[85%] shadow-sm">
            ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆë‚˜ìš”? <br><b>"ì´ ì§ë¬´ì˜ í•„ìˆ˜ ì—­ëŸ‰ì´ ë­ì•¼?"</b> ê°™ì´ ë¬¼ì–´ë³´ì„¸ìš”!
        </div>
    </div>
    <div class="p-4 border-t bg-white">
        <div class="flex gap-2">
            <input type="text" id="user-input" onkeypress="if(event.keyCode==13) sendMessage()"
                   class="flex-1 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
            <button onclick="sendMessage()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-bold">ì „ì†¡</button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // 1. ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
    const rawMarkdown = [[${result}]];
    const reportId = [[${reportId}]]; // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë„˜ê²¨ì¤€ ID

    if (rawMarkdown) {
        document.getElementById('content').innerHTML = marked.parse(rawMarkdown);
    }

    // 2. ì±„íŒ… ê¸°ëŠ¥
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const chatWindow = document.getElementById('chat-window');
        const message = input.value.trim();

        if (!message) return;

        // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        appendMessage('user', message);
        input.value = '';

        // ë¡œë”© í‘œì‹œ
        const loadingId = 'loading-' + Date.now();
        appendMessage('ai', 'ìƒê° ì¤‘...', loadingId);

        try {
            const response = await fetch('/resume/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, reportId: reportId })
            });
            const data = await response.text();

            // ë¡œë”© ë©”ì‹œì§€ ì œê±° í›„ AI ë‹µë³€ í‘œì‹œ
            document.getElementById(loadingId).remove();
            appendMessage('ai', data);
        } catch (error) {
            document.getElementById(loadingId).innerText = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        }
    }

    function appendMessage(sender, text, id = null) {
        const chatWindow = document.getElementById('chat-window');
        const wrapper = document.createElement('div');
        wrapper.className = 'flex ' + (sender === 'user' ? 'justify-end' : 'justify-start');
        if (id) wrapper.id = id;

        const msgDiv = document.createElement('div');
        msgDiv.className = sender === 'user'
            ? 'bg-white border border-gray-200 text-gray-800 p-3 rounded-lg text-sm max-w-[85%] shadow-sm'
            : 'bg-blue-100 text-blue-800 p-3 rounded-lg text-sm max-w-[85%] shadow-sm';

        msgDiv.innerText = text;

        if (sender === 'ai') {
            msgDiv.innerHTML = marked.parse(text);
        } else {
            msgDiv.innerText = text;
        }

        wrapper.appendChild(msgDiv);
        chatWindow.appendChild(wrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
</script>
</body>
</html>